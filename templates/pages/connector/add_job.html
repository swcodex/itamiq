{% block content %}
    <div id="main-container" class="container mt-3" style="margin-left: 20px;">
        <div class="row">
            <div class="col-7 col-md-7 col-lg-7">
                {% if messages %}
                    <div class="messages mb-4">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                <div id="notification-container"
                class="toastmessage"
                style="border-radius: 5px;
                    display: none;
                    position: fixed;
                    top: 45px;
                    right: 45px;
                    padding: 15px;
                    background: #333;
                    color: #ffffff;"
                ></div>
                <form id="job-form" method="post"
                      hx-post="{% url 'connector:add_job_api' %}"
                      hx-target="#notification-container"
                      hx-swap="innerHTML"
                      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                    {% csrf_token %}

                    <div class="card mb-4">
                        <h5 class="card-title mb-0">Job Details</h5>
                        <div class="card-body">
                            {% for field in job_form %}
                                {% if field.name != 'schedule_days' and field.name != 'schedule_time' %}
                                    <div class="mb-3">
                                        {{ field.label_tag }}
                                        {{ field }}
                                        {% if field.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ field.errors }}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <hr class="my-4" style="border-top: 1px solid #9e9e9e;">

                    <div class="card mb-4">
                        <h5 class="card-title mb-0">Schedule</h5>
                        <div class="card-body">
                            <div class="mb-3">
                                {{ job_form.schedule_days.label_tag }}
                                <div class="d-flex flex-wrap gap-3">
                                    {% for checkbox in job_form.schedule_days %}
                                        <div class="form-check">
                                            {{ checkbox.tag }}
                                            {{ checkbox.choice_label }}
                                        </div>
                                    {% endfor %}
                                </div>
                                {% if job_form.schedule_days.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ job_form.schedule_days.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="mb-3" style="max-width: 118px;">
                                {{ job_form.schedule_time.label_tag }}
                                {{ job_form.schedule_time }}
                                {% if job_form.schedule_time.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ job_form.schedule_time.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <hr class="my-4" style="border-top: 1px solid #9e9e9e;">

                    <div class="card mb-4">
                        <h5 class="card-title mb-0">Scripts</h5>
                        <div class="card-body">
                            {{ script_formset.management_form }}
                            {% if script_formset.non_form_errors %}
                                <div class="alert alert-danger">
                                    {{ script_formset.non_form_errors }}
                                </div>
                            {% endif %}
                            <div id="script-forms">
                                {% for script_form in script_formset %}
                                    <div class="script-form mb-4" data-form-id="{{ forloop.counter0 }}">
                                        <!-- Name field -->
                                        <div class="mb-3">
                                            {{ script_form.name.label_tag }}
                                            {% if script_form.name.field.required %}
                                                <span class="required">*</span>{% endif %}
                                            {{ script_form.name }}
                                            {% if script_form.name.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ script_form.name.errors }}
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Content field -->
                                        <div class="mb-3">
                                            {{ script_form.content.label_tag }}
                                            {% if script_form.content.field.required %}
                                                <span class="required">*</span>{% endif %}
                                            <div id="editor-{{ forloop.counter0 }}"
                                                 class="ace-editor ace-editor-container" style="height: 400px;"></div>
                                            {{ script_form.content }}
                                            <script>
                                                document.getElementById('{{ script_form.content.id_for_label }}').style.display = 'none';
                                            </script>
                                            {% if script_form.content.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ script_form.content.errors }}
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Table Name field -->
                                        <div class="mb-3">
                                            {{ script_form.table_name.label_tag }}
                                            {{ script_form.table_name }}
                                            {% if script_form.table_name.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ script_form.table_name.errors }}
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Order field -->
                                        <div class="mb-3">
                                            {{ script_form.order_exec.label_tag }}
                                            {{ script_form.order_exec }}
                                            {% if script_form.order_exec.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ script_form.order_exec.errors }}
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Import Enabled field -->
                                        <div class="mb-3">
                                            {{ script_form.import_enabled.label_tag }}
                                            {{ script_form.import_enabled }}
                                            {% if script_form.import_enabled.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ script_form.import_enabled.errors }}
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Delete checkbox -->
                                        <div class="mb-3">
                                            {{ script_form.DELETE.label_tag }}
                                            {{ script_form.DELETE }}
                                            {% if script_form.DELETE.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ script_form.DELETE.errors }}
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Hidden fields -->
                                        {% for hidden in script_form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    </div>
                                {% endfor %}
                            </div>
                            <button type="button" id="add-script" class="btn btn-outline-secondary">Add Another Script
                            </button>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'connector:job_list' %}" class="btn btn-outline-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Add Job</button>
                    </div>
                </form>


            <div id="toast"></div>

            </div>
        </div>
    </div>

    <div id="empty-form" style="display: none;">
        <hr class="my-4" style="border-top: 1px solid #9e9e9e;">
        <div class="script-form mb-4">
            <!-- Name field -->
            <div class="mb-3">
                {{ script_formset.empty_form.name.label_tag }}
                {% if script_formset.empty_form.name.field.required %}<span class="required">*</span>{% endif %}
                {{ script_formset.empty_form.name }}
            </div>

            <!-- Content field -->
            <div class="mb-3">
                {{ script_formset.empty_form.content.label_tag }}
                {% if script_formset.empty_form.content.field.required %}<span class="required">*</span>{% endif %}
                <div id="editor-__prefix__" class="ace-editor ace-editor-container" style="height: 400px;"></div>
                {{ script_formset.empty_form.content }}
                <script>document.getElementById('{{ script_formset.empty_form.content.id_for_label }}').style.display = 'none';</script>
            </div>

            <!-- Table Name field -->
            <div class="mb-3">
                {{ script_formset.empty_form.table_name.label_tag }}
                {{ script_formset.empty_form.table_name }}
            </div>

            <!-- Order field -->
            <div class="mb-3">
                {{ script_formset.empty_form.order_exec.label_tag }}
                {{ script_formset.empty_form.order_exec }}
            </div>

            <!-- Import Enabled field -->
            <div class="mb-3">
                {{ script_formset.empty_form.import_enabled.label_tag }}
                {{ script_formset.empty_form.import_enabled }}
            </div>

            <!-- Delete checkbox -->
            <div class="mb-3">
                {{ script_formset.empty_form.DELETE.label_tag }}
                {{ script_formset.empty_form.DELETE }}
            </div>

            <!-- Hidden fields -->
            {% for hidden in script_formset.empty_form.hidden_fields %}
                {{ hidden }}
            {% endfor %}
        </div>
    </div>

{% endblock %}

{% block extra_css %}
    <style>
        .card {
            border: none;
            border-radius: 0;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: none;
        }

        .form-control, .form-select {
            border-radius: 0;
        }

        .btn {
            border-radius: 0;
        }

        .ace-editor .ace_content {
            color: #ffffff;
        }

        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
        }

        .toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @-webkit-keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }
            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }
            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @-webkit-keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }
            to {
                bottom: 0;
                opacity: 0;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }
            to {
                bottom: 0;
                opacity: 0;
            }
        }
    </style>
{% endblock %}

{% block extra_js %}
    <script>
            var addScriptButton = document.getElementById('add-script');
            var scriptForms = document.getElementById('script-forms');
            var totalFormsInput = document.querySelector('#id_scripts-TOTAL_FORMS');
            var emptyForm = document.querySelector('#empty-form').innerHTML;
            document.querySelectorAll('.ace-editor').forEach((editorElement, index) => {
                initializeAceEditor(editorElement, index);
            });

            addScriptButton.addEventListener('click', function() {
                var formCount = scriptForms.children.length;
                var newForm = document.createElement('div');
                newForm.innerHTML = emptyForm.replace(/__prefix__/g, formCount);
                newForm.classList.add('script-form', 'mb-4');
                
                scriptForms.appendChild(newForm);
                totalFormsInput.value = formCount + 1;
            
                // Initialize the new editor
                var newEditorElement = newForm.querySelector('.ace-editor');
                initializeAceEditor(newEditorElement, formCount);
            
                // Hide the textarea
                var newTextarea = newForm.querySelector(`textarea[name$="-content"]`);
                if (newTextarea) {
                    newTextarea.style.display = 'none';
                }
            
                // Pre-populate the 'order' field
                var orderField = newForm.querySelector('input[name$="-order_exec"]');
                if (orderField) {
                    orderField.value = formCount + 1;
                }

                setupDeleteCheckbox(newForm);

            });

            function setupDeleteCheckbox(form) {
                var deleteCheckbox = form.querySelector('input[name$="-DELETE"]');
                if (deleteCheckbox) {
                    deleteCheckbox.addEventListener('change', function() {
                        form.style.opacity = this.checked ? '0.5' : '1';
                    });
                }
            }

            function setupAllDeleteCheckboxes() {
                document.querySelectorAll('.script-form').forEach(form => {
                    setupDeleteCheckbox(form);
                });
            }

            document.getElementById('job-form').addEventListener('reset', () => {
                var editors = document.querySelectorAll('.ace-editor');
                editors.forEach(editor => {
                    ace.edit(editor).setValue('');
                });
            });

        function initializeAceEditor(editorElement, index) {
            var editor = ace.edit(editorElement);
            editor.setTheme("ace/theme/textmate");
            editor.session.setMode("ace/mode/python");
            editor.setOptions({
                fontSize: "11pt",
                wrap: true,
                highlightActiveLine: true,
                highlightGutterLine: false,
                showPrintMargin: true
            });

            var textarea = document.querySelector(`#id_scripts-${index}-content`);
            if (textarea) {
                editor.setValue(textarea.value, -1);
            }

            editor.clearSelection();
            editor.moveCursorTo(0, 0);
            editor.blur();

            editor.on('change', () => {
                if (textarea) {
                    textarea.value = editor.getValue();
                }
            });

        }

            document.body.addEventListener('htmx:afterSwap', function(event) {
                var toast = document.querySelector('#notification-container');
                if (toast) {
                    var successResponse = event?.detail?.xhr?.response?.includes('success');
                    var errorResponse = event?.detail?.xhr?.response?.includes('error');
                    if (successResponse) {
                        toast.style.background = '#4CAF50';
                        document.getElementById('job-form').reset()
                    }
                    if (errorResponse) {
                        toast.style.background = '#f44336';
                    }

                    toast.style.display = 'block';
                    toast.style.opacity = '1';

                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => {
                            toast.style.display = 'none';
                        }, 500);
                    }, 3000);
                }
            });

    </script>
{% endblock %}
