{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Report Builder{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<h3>View Report Configuration</h3>

<!-- SQL Query Input -->
<div class="row mb-3">
    <div class="col-md-12">
        <textarea id="sql-query" class="form-control" rows="5" placeholder="Enter your SQL query here"></textarea>
    </div>
</div>

<!-- Generate Report Button -->
<div class="row mb-3">
    <div class="col-md-12">
        <button id="generate-report" class="btn btn-primary">Generate Report</button>
    </div>
</div>

<!-- Right Container -->
<div style="overflow: hidden; padding-left: 20px; max-width: 100%;">
    <!-- Report Results -->
    <div id="report-results" style="display: none;">
        <div id="length-menu-container"></div>
        <div id="button-container" class="d-flex justify-content-end align-items-center" style="margin-bottom: 15px;">
            <div class="col-md-3">
                <input type="text" id="save-config-name" class="form-control" placeholder="Configuration Name">
            </div>
            <div class="col-md-2">
                <button id="save-config" class="btn btn-primary">Save Configuration</button>
            </div>
            <div class="dt-buttons"></div>
        </div>  
        <div class="table-responsive">
            <table id="results-table" class="table table-striped" style="width:100%">
                <thead>
                    <tr id="table-headers"></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
$(document).ready(function() {
    console.log("Document ready");

    // Variables
    var dataTable;
    var savedColumnOrder;
    var configId = {{ config_id }};

    // Functions
    function initializeDataTable(columns, initialData) {
        // Clear existing content
        $('#length-menu-container').empty();

        if (dataTable) {
            dataTable.destroy();
            $('#results-table').empty();
        }

        var tableHeaders = $('#table-headers');
        tableHeaders.empty();

        columns.forEach(function(column) {
            tableHeaders.append($('<th>').text(column));
        });

        console.log("Initializing DataTable with columns:", columns);
        console.log("Initial data:", initialData);

        if (columns.length === 0) {
            columns = ['No Data'];
        }

        dataTable = $('#results-table').DataTable({
            columns: columns.map(function(column) {
                return { 
                    data: column, 
                    title: column,
                    render: function(data, type, row) {
                        return (data === null || data === undefined) ? '' : data;
                    }
                };
            }),
            data: initialData || [],
            pageLength: 10,
            searching: false,
            ordering: true,
            serverSide: true,
            processing: true,
            ajax: function(data, callback, settings) {
                fetchReportData(data, callback);
            },
            colReorder: true,
            dom: 'Blfrtip',
            buttons: [
                { 
                text: 'Reset Column Order', 
                className: 'btn btn-secondary custom-btn',
                action: function (e, dt, node, config) { resetColumnOrder(); } 
                },
                { 
                text: 'Export All to CSV', 
                className: 'btn btn-secondary custom-btn',
                action: async function (e, dt, node, config) { await exportAllData('csv'); } 
                },
                { 
                text: 'Export All to Excel', 
                className: 'btn btn-secondary custom-btn',
                action: async function (e, dt, node, config) { await exportAllData('excel'); } 
                }
            ],
            language: {
                emptyTable: 'No records found',
                zeroRecords: 'No matching records found'
            }
        });

        // Move DataTables buttons to the button container
        dataTable.buttons().container().appendTo('#button-container .dt-buttons');

        console.log("DataTable initialized:", dataTable);
    }

    function saveColumnOrder() {
        var columnOrder = dataTable.colReorder.order();
        localStorage.setItem('columnOrder', JSON.stringify(columnOrder));
        alert('Column order saved!');
    }

    function resetColumnOrder() {
        localStorage.removeItem('columnOrder');
        dataTable.colReorder.reset();
        alert('Column order reset!');
    }

    async function exportAllData(type) {
        var sqlQuery = $('#sql-query').val();
    
        var requestData = {
            sql_query: sqlQuery,
            export_type: type,
            column_order: dataTable.columns().indexes().toArray().map(function(index) {
                return dataTable.column(index).dataSrc();
            })
        };
    
        try {
            const response = await $.ajax({
                url: '{% url "reports:export_report_sql" %}',
                method: 'POST',
                data: JSON.stringify(requestData),
                contentType: 'application/json',
                xhrFields: {
                    responseType: 'blob'
                }
            });
    
            var filename = "report_export." + (type === 'csv' ? 'csv' : 'xlsx');
            var url = window.URL.createObjectURL(response);
            var a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            console.error("Error exporting data:", error);
            if (error.responseJSON) {
                alert('An error occurred while exporting the data: ' + error.responseJSON.error);
            } else {
                alert('An error occurred while exporting the data. Please check the console for more details.');
            }
        }
    }
    

    async function generateReport() {
        var sqlQuery = $('#sql-query').val();
        console.log("Generating report with SQL query:", sqlQuery);
    
        if (!sqlQuery) {
            console.error("No SQL query found");
            alert("No SQL query found. Please enter a query and try again.");
            return;
        }
    
        var requestData = {
            sql_query: sqlQuery,
            page: 1,
            per_page: 10
        };
    
        console.log("Sending report generation request:", requestData);
    
        try {
            const data = await $.ajax({
                url: '{% url "reports:generate_report_sql" %}',
                method: 'POST',
                data: JSON.stringify(requestData),
                contentType: 'application/json'
            });
    
            console.log("Report generated successfully:", data);
    
            var columns = [];
            if (data.results && data.results.length > 0) {
                columns = Object.keys(data.results[0] || {});
            }
    
            initializeDataTable(columns, data.results || []);
    
            $('#report-results').show();
        } catch (error) {
            console.error("Error generating report:", error);
            alert('An error occurred while generating the report. Check the console for more details.');
        }
    }
    

    async function fetchReportData(dtData, callback) {
        var sqlQuery = $('#sql-query').val();

        var requestData = {
            sql_query: sqlQuery,
            page: Math.floor(dtData.start / dtData.length) + 1,
            per_page: dtData.length
        };

        try {
            const data = await $.ajax({
                url: '{% url "reports:generate_report_sql" %}',
                method: 'POST',
                data: JSON.stringify(requestData),
                contentType: 'application/json'
            });

            callback({
                draw: dtData.draw,
                recordsTotal: data.total_count || 0,
                recordsFiltered: data.total_count || 0,
                data: data.results || []
            });
        } catch (error) {
            console.error("Error fetching report data:", error);
            callback({
                draw: dtData.draw,
                recordsTotal: 0,
                recordsFiltered: 0,
                data: []
            });
        }
    }

    async function loadReportConfiguration() {
        try {
            const response = await $.ajax({
                url: '{% url "reports:load_configuration" config_id=config_id %}',
                method: 'GET',
                dataType: 'json'
            });
    
            console.log("Load configuration response:", response);
    
            if (response && typeof response === 'object' && response.sqlQuery) {
                console.log("Parsed configuration:", response);
                $('#sql-query').val(response.sqlQuery);
                savedColumnOrder = response.columnOrder;
                
                // Generate the report
                await generateReport();
    
                // Apply the saved column order
                if (savedColumnOrder && dataTable) {
                    dataTable.colReorder.order(savedColumnOrder);
                }
            } else {
                console.error("Unexpected response format:", response);
                alert('Unexpected response format when loading configuration.');
            }
        } catch (error) {
            console.error("Error loading report configuration:", error);
            if (error.responseJSON && error.responseJSON.error) {
                alert('Error: ' + error.responseJSON.error);
            } else {
                alert('An error occurred while loading the report configuration. Please try again.');
            }
        }
    }
    

    // Event Listeners
    $('#generate-report').click(async function() {
        try {
            await generateReport();
        } catch (error) {
            console.error("Error generating report:", error);
            alert('An error occurred while generating the report. Please try again.');
        }
    });

    $('#save-config').click(async function() {
        var name = $('#save-config-name').val().trim();
        if (!name) {
            $('#save-config-name').addClass('is-invalid');
            return;
        }
        $('#save-config-name').removeClass('is-invalid');

        var configuration = {
            sqlQuery: $('#sql-query').val(),
            columnOrder: dataTable ? dataTable.colReorder.order() : null
        };

        var data = {
            name: name,
            configuration: configuration,
            sql_report: true  // Add this line to set sql_report to true
        };

        try {
            const response = await $.ajax({
                url: '{% url "reports:save_configuration" %}',
                method: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json'
            });
            alert('Configuration saved successfully');
        } catch (xhr) {
            if (xhr.status === 409) {
                if (confirm('A configuration with this name already exists. Do you want to overwrite it?')) {
                    configuration.overwrite = true;
                    try {
                        await $.ajax({
                            url: '{% url "reports:save_configuration" %}',
                            method: 'POST',
                            data: JSON.stringify({name: name, configuration: configuration}),
                            contentType: 'application/json'
                        });
                        alert('Configuration overwritten successfully');
                    } catch (error) {
                        alert('Error saving configuration: ' + error);
                    }
                }
            } else {
                alert('Error saving configuration: ' + xhr.responseText);
            }
        }
    });

    // Initial Setup
    (async function init() {
        try {
            console.log("Initializing with config_id:", configId);
            await loadReportConfiguration();
        } catch (error) {
            console.error("Error during initialization:", error);
            alert('An error occurred during initialization. Please refresh the page and try again.');
        }
    })();
});
</script>
{% endblock %}
