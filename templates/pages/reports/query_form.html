{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Report Builder{% endblock %}

{% block extra_css %}

{% endblock %}

{% block content %}
<h3>View Report Configuration</h3>

<!--
<div class="row mb-3">
    <div class="col-md-6">
        <select id="load-config" class="form-control">
            <option value="">Load Saved Configuration</option>
        </select>
    </div>
</div>
-->

<!-- Left Container -->
<div style="width: 320px; float: left; margin-right: 10px;">
    <!-- Table Selection -->
    <div class="table-selection-container" style="width: 90%; margin-bottom: 15px;">
        <select id="table-select" class="form-control">
            <option value="">Select a table</option>
        </select>
    </div>

    <!-- Filter and Generate Controls -->
    <button id="generate-report" class="btn btn-secondary" style="display: none;">Generate Report</button>

    <!-- Columns Container -->
    <div id="columns-container" style="display: none;">
        <h5>Columns</h5>
        <div id="columns-list"></div>
    </div>

    <!-- Related Tables Container -->
    <div id="related-tables-container" style="display: none;">
        <h5>Related Tables</h5>
        <div id="related-tables-list"></div>
    </div>
</div>

<!-- Right Container -->
<div style="overflow: hidden; padding-left: 20px; max-width: 100%;">
    <!-- Active Filters Display -->
    <div id="active-filters" style="display: none; margin-bottom: 15px;">
        <h4>Active Filters:</h4>
        <div id="filter-list"></div>
    </div>

     
    <!-- Report Results -->
    <div id="report-results" style="display: none;">
        <div id="length-menu-container"></div>
        <div id="button-container" class="d-flex justify-content-end align-items-center" style="margin-bottom: 15px;">
            <div class="col-md-3">
                <input type="text" id="save-config-name" class="form-control" placeholder="Configuration Name">
            </div>
            <div class="col-md-2">
                <button id="save-config" class="btn btn-primary">Save Configuration</button>
            </div>
            <button id="filter-button" class="btn btn-secondary custom-btn" style="display: none;">Filter</button>
            <div class="dt-buttons"></div>
        </div>  
        <div class="table-responsive">
            <table id="results-table" class="table table-striped" style="width:100%">
                <thead>
                    <tr id="table-headers"></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>



<!-- Filter Modal -->
<div class="modal fade" id="filter-modal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Set Filters</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Query Builder should appear below:</p>
                <div id="query-builder"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="apply-filters">Apply Filters</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        console.log("Document ready");
    
        // Variables
        var dataTable;
        var queryBuilderFilters = [];
        var queryBuilderRules = null;
    
        // Functions
        async function loadTables() {
            try {
                const data = await $.get('{% url "reports:get_tables" %}');
                console.log("Loaded tables:", data);
                data.forEach(function(table) {
                    $('#table-select').append($('<option>', {
                        value: table.id,
                        text: table.name
                    }));
                });
            } catch (error) {
                console.error("Error loading tables:", error);
            }
        }
    
        async function loadColumns(tableId) {
            console.log("Loading columns for table ID:", tableId);
            try {
                const data = await $.get('{% url "reports:get_columns" 0 %}'.replace('0', tableId));
                console.log("Loaded columns:", data);
                const columnsList = $('#columns-list');
                columnsList.empty();
                data.forEach(function(column) {
                    columnsList.append(
                        $('<div>').append(
                            $('<label>').append(
                                $('<input>', {
                                    type: 'checkbox',
                                    name: 'columns[]',
                                    value: column.id,
                                    style: 'margin-right: 3px; margin-bottom: 7px;'
                                }),
                                $('<span>').text(column.name)
                            )
                        )
                    );
                });
                return data;
            } catch (error) {
                console.error("Error loading columns:", error);
                throw error;
            }
        }
    
        async function loadRelatedTables(tableId) {
            console.log("Loading related tables for table ID:", tableId);
            const includeIndirect = $('#include-indirect-relations').is(':checked');
            console.log("Include indirect relations:", includeIndirect);
    
            try {
                const data = await $.get('{% url "reports:get_related_tables" 0 %}'.replace('0', tableId) + '?include_indirect=' + includeIndirect);
                console.log("Loaded related tables:", data);
                const relatedTablesList = $('#related-tables-list');
                relatedTablesList.empty();
    
                await Promise.all(data.map(async (relatedTable, index) => {
                    var tableDiv = $('<div>', { class: 'card', style: 'width: 100%; margin-bottom: 10px;' });
                    var tableHeader = $('<div>', { class: 'card-header', id: 'heading' + index });
                    var tableButton = $('<button>', {
                        class: 'btn btn-link',
                        type: 'button',
                        'data-target': '#collapse' + index,
                        text: relatedTable.name,
                        style: 'white-space: normal; word-wrap: break-word; text-align: left; width: 100%; padding: 0;'
                    });
                    tableHeader.append(tableButton);
                    tableDiv.append(tableHeader);
    
                    var collapseDiv = $('<div>', { id: 'collapse' + index, class: 'collapse' });
                    var cardBody = $('<div>', { class: 'card-body' });
                    var columnsList = $('<div>', { style: 'margin-left: -23px; margin-top: -25px; margin-bottom: -25px;' });
                    cardBody.append(columnsList);
                    collapseDiv.append(cardBody);
                    tableDiv.append(collapseDiv);
                    relatedTablesList.append(tableDiv);
    
                    const columns = await $.get('{% url "reports:get_columns" 0 %}'.replace('0', relatedTable.id));
                    console.log("Loaded columns for related table:", relatedTable.name, columns);
                    columns.forEach(function(column) {
                        columnsList.append(
                            $('<div>').append(
                                $('<label>').append(
                                    $('<input>', {
                                        type: 'checkbox',
                                        name: 'columns[]',
                                        value: column.id,
                                        style: 'margin-right: 3px; margin-bottom: 7px;'
                                    }),
                                    $('<span>').text(column.name)
                                )
                            )
                        );
                    });
                }));
    
                $('#related-tables-list .btn-link').click(function() {
                    var target = $($(this).data('target'));
                    target.collapse('toggle');
                });

    
                return data;
            } catch (error) {
                console.error("Error loading related tables:", error);
                throw error;
            }
        }
    
        async function loadSavedConfigurations() {
            try {
                const data = await $.get('{% url "reports:get_configurations" %}');
                $('#load-config').empty().append('<option value="">Load Saved Configuration</option>');
                data.forEach(function(config) {
                    $('#load-config').append($('<option>', {
                        value: config.id,
                        text: config.name
                    }));
                });
            } catch (error) {
                console.error("Error loading saved configurations:", error);
                throw error;
            }
        }

    function initializeDataTable(columns, initialData) {
        // Clear existing content
        $('#length-menu-container').empty();

        if (dataTable) {
            dataTable.destroy();
            $('#results-table').empty();
        }

        var tableHeaders = $('#table-headers');
        tableHeaders.empty();

        columns.forEach(function(column) {
            tableHeaders.append($('<th>').text(column));
        });

        console.log("Initializing DataTable with columns:", columns);
        console.log("Initial data:", initialData);

        if (columns.length === 0) {
            columns = ['No Data'];
        }

        dataTable = $('#results-table').DataTable({
            columns: columns.map(function(column) {
                return { 
                    data: column, 
                    title: column,
                    render: function(data, type, row) {
                        return (data === null || data === undefined) ? '' : data;
                    }
                };
            }),
            data: initialData || [],
            pageLength: 10,
            searching: false,
            ordering: true,
            serverSide: true,
            processing: true,
            ajax: function(data, callback, settings) {
                fetchReportData(data, callback);
            },
            colReorder: true,
            dom: 'Blfrtip',
            buttons: [
                { 
                text: 'Reset Column Order', 
                className: 'btn btn-secondary custom-btn',
                action: function (e, dt, node, config) { resetColumnOrder(); } 
                },
                { 
                text: 'Export All to CSV', 
                className: 'btn btn-secondary custom-btn',
                action: async function (e, dt, node, config) { await exportAllData('csv'); } 
                },
                { 
                text: 'Export All to Excel', 
                className: 'btn btn-secondary custom-btn',
                action: async function (e, dt, node, config) { await exportAllData('excel'); } 
                }
            ],
            language: {
                emptyTable: 'No records found',
                zeroRecords: 'No matching records found'
            }
        });

        // Move DataTables buttons to the button container
        dataTable.buttons().container().appendTo('#button-container .dt-buttons');

        // Show the filter button if it's supposed to be visible
        $('#filter-button').css('display', '');

        console.log("DataTable initialized:", dataTable);
    }

    function saveColumnOrder() {
        var columnOrder = dataTable.colReorder.order();
        localStorage.setItem('columnOrder', JSON.stringify(columnOrder));
        alert('Column order saved!');
    }

    function resetColumnOrder() {
        localStorage.removeItem('columnOrder');
        dataTable.colReorder.reset();
        alert('Column order reset!');
    }

    async function exportAllData(type) {
        var selectedColumns = $('input[name="columns[]"]:checked').map(function() {
            return $(this).val();
        }).get();
        var mainTableId = $('#table-select').val();

        var columnOrder = dataTable.columns().indexes().toArray();
        var columnIdOrder = columnOrder.map(function(index) {
            return dataTable.column(index).dataSrc();
        });

        var requestData = {
            columns: selectedColumns,
            main_table_id: mainTableId,
            page: 1,
            per_page: 1000000,
            export_type: type,
            column_order: columnIdOrder,
            filters: queryBuilderRules
        };

        try {
            const response = await $.ajax({
                url: '{% url "reports:export_report" %}',
                method: 'POST',
                data: JSON.stringify(requestData),
                contentType: 'application/json',
                xhrFields: {
                    responseType: 'blob'
                }
            });

            var filename = "report_export." + (type === 'csv' ? 'csv' : 'xlsx');
            var url = window.URL.createObjectURL(response);
            var a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

        } catch (error) {
            console.error("Error exporting data:", error);
            alert('An error occurred while exporting the data. Please try again.');
        }
    }

    function updateQueryBuilderFilters() {
        console.log("Updating QueryBuilder filters");
        var existingRules = null;
        try {
            existingRules = $('#query-builder').queryBuilder('getRules');
        } catch (e) {
            console.log("No existing rules found");
        }
        queryBuilderFilters = [];
    
        function processColumns(container) {
            $(container).find('input[name="columns[]"]:checked').each(function() {
                var columnId = $(this).val();
                var columnName = $(this).siblings('span').text().split(' (')[0];
                var dataType = $(this).siblings('span').text().split('(')[1]?.split(')')[0] || 'string';
    
                queryBuilderFilters.push({
                    id: columnId,
                    label: columnName,
                    type: mapDataType(dataType)
                });
            });
        }
    
        processColumns('#columns-list');
        $('#related-tables-list .card-body').each(function() {
            processColumns(this);
        });
    
        console.log("Updated queryBuilderFilters:", queryBuilderFilters);
    
        if (queryBuilderFilters.length > 0) {
            initQueryBuilder(existingRules);
        } else {
            console.warn("No filters selected, QueryBuilder not initialized");
            $('#query-builder').empty();
            queryBuilderRules = null;
        }
    }
    

    function mapDataType(dataType) {
        switch(dataType.toLowerCase()) {
            case 'integer':
            case 'bigint':
                return 'integer';
            case 'float':
            case 'double':
            case 'decimal':
                return 'double';
            case 'date':
                return 'date';
            case 'datetime':
                return 'datetime';
            case 'boolean':
                return 'boolean';
            default:
                return 'string';
        }
    }

    function initQueryBuilder(existingRules) {
        console.log("Initializing QueryBuilder");
        console.log("Current queryBuilderFilters:", queryBuilderFilters);
    
        if (!queryBuilderFilters || queryBuilderFilters.length === 0) {
            console.error("queryBuilderFilters is empty or undefined");
            return;
        }
    
        const $queryBuilder = $('#query-builder');
    
        // Safely destroy existing instance if it exists
        try {
            $queryBuilder.queryBuilder('destroy');
        } catch (e) {
            console.log("QueryBuilder not initialized yet");
        }
    
        // Function to validate and clean rules
        function validateRules(rules, validFilters) {
            if (!rules || !rules.rules) return null;
            
            const validRules = {
                condition: rules.condition,
                rules: rules.rules.filter(rule => {
                    if (rule.rules) {
                        return validateRules(rule, validFilters);
                    }
                    return validFilters.some(filter => filter.id === rule.field);
                }).map(rule => {
                    if (rule.rules) {
                        return validateRules(rule, validFilters);
                    }
                    return rule;
                })
            };
    
            return validRules.rules.length > 0 ? validRules : null;
        }
    
        // Validate and clean existing rules
        const validatedRules = validateRules(existingRules, queryBuilderFilters);
    
        try {
            $queryBuilder.queryBuilder({
                filters: queryBuilderFilters,
                operators: [
                    'equal', 'not_equal', 'in', 'not_in', 'less', 'less_or_equal',
                    'greater', 'greater_or_equal', 'between', 'not_between',
                    'begins_with', 'not_begins_with', 'contains', 'not_contains',
                    'ends_with', 'not_ends_with', 'is_empty', 'is_not_empty', 'is_null', 'is_not_null'
                ],
                allow_empty: true
            });
    
            if (validatedRules && validatedRules.rules && validatedRules.rules.length > 0) {
                $queryBuilder.queryBuilder('setRules', validatedRules);
            } else if (existingRules && existingRules.rules && existingRules.rules.length > 0) {
                console.warn("Existing rules were invalid for the current filters and have been cleared.");
            }
    
            console.log("QueryBuilder initialized successfully");
            
            // Update queryBuilderRules with the current rules
            queryBuilderRules = $queryBuilder.queryBuilder('getRules');
        } catch (error) {
            console.error("Error initializing QueryBuilder:", error);
            queryBuilderRules = null;
        }
    }
    
    
    async function generateReport() {
        var selectedColumns = $('input[name="columns[]"]:checked').map(function() {
            return $(this).val();
        }).get();
        var mainTableId = $('#table-select').val();
    
        try {
            queryBuilderRules = $('#query-builder').queryBuilder('getRules');
        } catch (e) {
            console.log("No active QueryBuilder rules");
            queryBuilderRules = null;
        }
    
        var requestData = {
            columns: selectedColumns,
            main_table_id: mainTableId,
            page: 1,
            per_page: 10,
            filters: queryBuilderRules
        };

        console.log("Sending report generation request:", requestData);

        try {
            const data = await $.ajax({
                url: '{% url "reports:generate_report" %}',
                method: 'POST',
                data: JSON.stringify(requestData),
                contentType: 'application/json'
            });

            console.log("Report generated successfully:", data);

            var columns = [];
            if (data.results && data.results.length > 0) {
                columns = Object.keys(data.results[0] || {});
            } else {
                columns = $('input[name="columns[]"]:checked').map(function() {
                    return $(this).siblings('span').text().split(' (')[0];
                }).get();
            }

            initializeDataTable(columns, data.results || []);

            var savedColumnOrder = localStorage.getItem('columnOrder');
            if (savedColumnOrder) {
                dataTable.colReorder.order(JSON.parse(savedColumnOrder));
            }
            updateActiveFilters();
            $('#report-results').show();
        } catch (error) {
            console.error("Error generating report:", error);
            alert('An error occurred while generating the report. Check the console for more details.');
        }
    }

    async function fetchReportData(dtData, callback) {
        var selectedColumns = $('input[name="columns[]"]:checked').map(function() {
            return $(this).val();
        }).get();
        var mainTableId = $('#table-select').val();

        var requestData = {
            columns: selectedColumns,
            main_table_id: mainTableId,
            page: Math.floor(dtData.start / dtData.length) + 1,
            per_page: dtData.length,
            filters: queryBuilderRules
        };

        try {
            const data = await $.ajax({
                url: '{% url "reports:generate_report" %}',
                method: 'POST',
                data: JSON.stringify(requestData),
                contentType: 'application/json'
            });

            callback({
                draw: dtData.draw,
                recordsTotal: data.total_count || 0,
                recordsFiltered: data.total_count || 0,
                data: data.results || []
            });
        } catch (error) {
            console.error("Error fetching report data:", error);
            callback({
                draw: dtData.draw,
                recordsTotal: 0,
                recordsFiltered: 0,
                data: []
            });
        }
    }

    function updateActiveFilters() {
        var rules = $('#query-builder').queryBuilder('getRules');
        queryBuilderRules = rules; // Update the global queryBuilderRules
        if (rules && rules.rules && rules.rules.length > 0) {
            var filterList = $('#filter-list');
            filterList.empty();
    
            function addRule(rule) {
                var filter = queryBuilderFilters.find(f => f.id === rule.field);
                var fieldName = filter ? filter.label : rule.field;
                var filterText = fieldName + ' ' + rule.operator + ' ' + rule.value;
                filterList.append($('<div>').text(filterText));
            }
    
            function processRuleSet(ruleSet) {
                filterList.append($('<div>').text(ruleSet.condition));
                ruleSet.rules.forEach(function(rule) {
                    if (rule.condition) {
                        processRuleSet(rule);
                    } else {
                        addRule(rule);
                    }
                });
            }
    
            processRuleSet(rules);
            $('#active-filters').show();
        } else {
            $('#active-filters').hide();
        }
    }
    

    // Event Listeners
    $('#table-select').change(async function() {
        var tableId = $(this).val();
        console.log("Selected table ID:", tableId);
        if (tableId) {
            try {
                await Promise.all([
                    loadColumns(tableId),
                    loadRelatedTables(tableId)
                ]);
                $('#columns-container, #related-tables-container, #generate-report, #filter-button').show();
                updateQueryBuilderFilters();
            } catch (error) {
                console.error("Error loading table data:", error);
                alert('An error occurred while loading table data. Please try again.');
            }
        } else {
            $('#columns-container, #related-tables-container, #generate-report, #filter-button').hide();
        }
    });

    $('#save-config').click(async function() {
        var name = $('#save-config-name').val().trim();
        if (!name) {
            $('#save-config-name').addClass('is-invalid');
            return;
        }
        $('#save-config-name').removeClass('is-invalid');

        var configuration = {
            selectedColumns: $('input[name="columns[]"]:checked').map(function() {
                return $(this).val();
            }).get(),
            mainTableId: $('#table-select').val(),
            filters: queryBuilderRules,
            columnOrder: dataTable.colReorder.order()
        };

        try {
            const response = await $.ajax({
                url: '{% url "reports:save_configuration" %}',
                method: 'POST',
                data: JSON.stringify({name: name, configuration: configuration}),
                contentType: 'application/json'
            });
            alert('Configuration saved successfully');
            await loadSavedConfigurations();
        } catch (xhr) {
            if (xhr.status === 409) {
                if (confirm('A configuration with this name already exists. Do you want to overwrite it?')) {
                    configuration.overwrite = true;
                    try {
                        await $.ajax({
                            url: '{% url "reports:save_configuration" %}',
                            method: 'POST',
                            data: JSON.stringify({name: name, configuration: configuration}),
                            contentType: 'application/json'
                        });
                        alert('Configuration overwritten successfully');
                        await loadSavedConfigurations();
                    } catch (error) {
                        alert('Error saving configuration: ' + error);
                    }
                }
            } else {
                alert('Error saving configuration: ' + xhr.responseText);
            }
        }
    });

    $('#load-config').change(async function() {
        var configId = $(this).val();
        if (configId) {
            try {
                const config = await $.get('{% url "reports:load_configuration" 0 %}'.replace('0', configId));

                $('input[name="columns[]"]').prop('checked', false);
                $('#table-select').val(config.mainTableId).trigger('change');

                await Promise.all([
                    loadColumns(config.mainTableId),
                    loadRelatedTables(config.mainTableId)
                ]);

                config.selectedColumns.forEach(function(columnId) {
                    $('input[name="columns[]"][value="' + columnId + '"]').prop('checked', true);
                });

                updateQueryBuilderFilters();

                if (config.filters && config.filters.rules && config.filters.rules.length > 0) {
                    $('#query-builder').queryBuilder('setRules', config.filters);
                    queryBuilderRules = config.filters;
                }

                updateActiveFilters();
                await generateReport();

                if (config.columnOrder && dataTable) {
                    dataTable.colReorder.order(config.columnOrder);
                }
            } catch (error) {
                console.error("Error loading configuration:", error);
                alert('An error occurred while loading the configuration. Please try again.');
            }
        }
    });

    $(document).on('change', 'input[name="columns[]"]', function() {
        updateQueryBuilderFilters();
        if (queryBuilderRules) {
            initQueryBuilder(queryBuilderRules);
            updateActiveFilters();
        } else {
            $('#active-filters').hide();
        }
    });

    $('#filter-button').click(function() {
        console.log("Filter button clicked");
        $('#filter-modal').modal('show');
    });

    $('#apply-filters').click(function() {
        queryBuilderRules = $('#query-builder').queryBuilder('getRules');
        $('#filter-modal').modal('hide');
        updateActiveFilters();
        generateReport();
    });

    $('#generate-report').click(async function() {
        try {
            await generateReport();
        } catch (error) {
            console.error("Error generating report:", error);
            alert('An error occurred while generating the report. Please try again.');
        }
    });

    // Initial Setup
    (async function init() {
        try {
            await loadTables();
            await loadSavedConfigurations();
        } catch (error) {
            console.error("Error during initialization:", error);
            alert('An error occurred during initialization. Please refresh the page and try again.');
        }
    })();
});

</script>
{% endblock %}